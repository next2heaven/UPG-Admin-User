/**
 * @class
 * @extends PIXI.Container
 * @memberof PIXI
 * @PIXI v4 ONLY
 * version: 1.1
 * mobile: supported
 * require: Hammer JS
 */
(function(){function a(a){PIXI.Container.call(this),this.name="TransformTool",this.interactive=!0,this.buttonMode=!0,this.corners=[],this.canvas=a&&"undefined"!=typeof a.canvas?a.canvas:null,this.SCALE_BY_RATIO=!(!a||"undefined"==typeof a.scaleByRatio)&&a.scaleByRatio,this.DEBUGGING=!(!a||"undefined"==typeof a.debug)&&a.debug,this.LOCK_REGISTRATION_POINT=!(!a||"undefined"==typeof a.lockReg)&&a.lockReg,this.CTRL_HOLD=!!this.LOCK_REGISTRATION_POINT,this.CONTROL_SIZE=a&&"undefined"!=typeof a.controlSize?a.controlSize:5,this.RELATIVE_SCALE=a&&"undefined"!=typeof a.relativeScale?a.relativeScale:1,this.SHOW_BORDER=!(!a||"undefined"==typeof a.border)&&a.border,this.ON_CHANGE_CALLBACK=null;var b=this,c=this;if(this.canvas&&"desktop"!=GDevice.type){this.hammer=new Hammer(this.canvas),this.hammer.get("pinch").set({enable:!0}),this.hammer.get("rotate").set({enable:!0});var d=new Hammer.Pinch,e=new Hammer.Rotate;d.recognizeWith(e),this.hammer.add([d,e]);var f=1,g=1,h=0,i={x:0,y:0},j={x:0,y:0};this.hammer.on("pinchstart",function(a){g=a.scale,i={x:a.center.x-$(b.canvas).offset().left,y:a.center.y-$(b.canvas).offset().top},i.x/=b.RELATIVE_SCALE,i.y/=b.RELATIVE_SCALE,j={x:b.target.x,y:b.target.y}}),this.hammer.on("pinchmove",function(a){h=a.scale-g,b.target&&(b.target.scale.x=b.target.scale.y=f+h,b._positionControls());var d={x:a.center.x-$(b.canvas).offset().left,y:a.center.y-$(b.canvas).offset().top};d.x/=b.RELATIVE_SCALE,d.y/=b.RELATIVE_SCALE;var e={x:d.x-i.x,y:d.y-i.y};c.target.position.x=j.x+e.x,c.target.position.y=j.y+e.y,c.translateLayer.x=c.target.x,c.translateLayer.y=c.target.y});var k=1,l=1,m=0;this.hammer.on("rotatestart",function(a){l=GMath.degToRad(a.rotation),k=b.target.rotation}),this.hammer.on("rotatemove",function(a){m=GMath.degToRad(a.rotation)-l,b.target&&(b.target.rotation=k+m,b.rotateLayer.rotation=b.target.rotation,b._positionControls())}),this.hammer.on("pan",function(a){}),$(this.canvas).on("touchstart",function(a){f=b.target.scale.x,k=b.target.rotation})}else console.log("[TransformTool] Can't setup touch manager because canvas parameter is missed.");var b=this;$(window).keydown(function(a){16==a.which&&(b.SCALE_BY_RATIO=!0),b.LOCK_REGISTRATION_POINT||91==a.which&&(b.CTRL_HOLD=!0)}),$(window).keyup(function(a){16==a.which&&(b.SCALE_BY_RATIO=!1),b.LOCK_REGISTRATION_POINT||91==a.which&&(b.CTRL_HOLD=!1)}),this.visible=!1}a.prototype=Object.create(PIXI.Container.prototype),a.prototype.constructor=a,a.prototype.clear=function(){for(var a=0;a<this.children.length;a++){var b=this.children[a];this.removeChild(b),b.destroy(),b=null}this.target=null,this.visible=!1},a.prototype.apply=function(a){var b=this;b.DEBUGGING&&console.log("[TransformTool] Apply"),this.clear(),this.clear(),this.target=a,GPixi.moveToTop(this),a.originalSize={width:a.width/a.scale.x,height:a.height/a.scale.y},b.DEBUGGING&&console.log("target.originalSize:",a.originalSize),b.DEBUGGING&&console.log("target.pivot:",a.pivot.x,"x",a.pivot.y),b.DEBUGGING&&a.anchor&&console.log("target.anchor:",a.anchor.x,"x",a.anchor.y),b.DEBUGGING&&console.log("target.size:",a.width,"x",a.height),a.anchor&&!a.ignoreResetAnchor&&a.anchor.x!=a.pivot.x/a.originalSize.width&&a.anchor.y!=a.pivot.y/a.originalSize.height&&(a.anchor.x=a.pivot.x/a.originalSize.width,a.anchor.y=a.pivot.y/a.originalSize.height,a.ignoreResetAnchor=!0),GPixi.usePivotPercent(a);var c=new PIXI.Graphics;b.DEBUGGING?c.beginFill(16776960,.2):c.beginFill(16776960,0),b.SHOW_BORDER&&c.lineStyle(1,0,.8),c.drawRect(0,0,a.originalSize.width,a.originalSize.height);var d=new PIXI.Graphics;d.lineStyle(1,0,1),d.beginFill(16777215,1),d.drawCircle(0,0,b.CONTROL_SIZE/b.RELATIVE_SCALE);var e=new PIXI.Container;e.ghostLayer=c,e.addChild(c),e.addChild(d);for(var f=new PIXI.Container,g=new PIXI.Container,h=0;h<4;h++){var i=new PIXI.Graphics;i.lineStyle(1,0,1),i.beginFill(16777215,1),i.drawRect(0,0,2*b.CONTROL_SIZE/b.RELATIVE_SCALE,2*b.CONTROL_SIZE/b.RELATIVE_SCALE),i.pivot.set(b.CONTROL_SIZE/b.RELATIVE_SCALE,b.CONTROL_SIZE/b.RELATIVE_SCALE),i.id=h,f["p"+h]=i,f.addChild(i),0==h&&i.position.set(-a.width*a.pivotPercent.x,-a.height*a.pivotPercent.y),1==h&&i.position.set(a.width*(1-a.pivotPercent.x),-a.height*a.pivotPercent.y),2==h&&i.position.set(a.width*(1-a.pivotPercent.x),a.height*(1-a.pivotPercent.y)),3==h&&i.position.set(-a.width*a.pivotPercent.x,a.height*(1-a.pivotPercent.y))}g.addChild(e);var j=new PIXI.Graphics;j.lineStyle(1,0,1),j.beginFill(16776960,1),j.drawCircle(0,0,b.CONTROL_SIZE/b.RELATIVE_SCALE),j.name="rotateControl1";var k=new PIXI.Graphics;k.lineStyle(1,0,1),k.beginFill(16776960,1),k.drawCircle(0,0,b.CONTROL_SIZE/b.RELATIVE_SCALE),k.name="rotateControl2";var l=new PIXI.Graphics;l.lineStyle(1,0,1),l.beginFill(16776960,1),l.drawCircle(0,0,b.CONTROL_SIZE/b.RELATIVE_SCALE),l.name="rotateControl3";var m=new PIXI.Graphics;m.lineStyle(1,0,1),m.beginFill(16776960,1),m.drawCircle(0,0,b.CONTROL_SIZE/b.RELATIVE_SCALE),m.name="rotateControl4";var n=new PIXI.Container;n.addChild(g),n.addChild(f),n.addChild(j),n.addChild(k),n.addChild(l),n.addChild(m);var o=new PIXI.Graphics;o.lineStyle(1,0,1),o.beginFill(16711680,1),o.drawCircle(0,0,b.CONTROL_SIZE/b.RELATIVE_SCALE);var p=new PIXI.Container;if(p.addChild(n),this.addChild(p),this.registrationControl=d,this.scaleControl=f,this.rotateControl=j,this.rotateControl2=k,this.rotateControl3=l,this.rotateControl4=m,this.ghostLayer=c,this.registrationLayer=e,this.scaleLayer=g,this.rotateLayer=n,this.translateLayer=p,p.position=a.position,n.rotation=a.rotation,g.scale=a.scale,c.position.x=-a.originalSize.width*a.pivotPercent.x,c.position.y=-a.originalSize.height*a.pivotPercent.y,this._positionControls(),this.LOCK_REGISTRATION_POINT&&(d.visible=!1),"desktop"!=GDevice.type&&(j.visible=!1,k.visible=!1,l.visible=!1,m.visible=!1,d.visible=!1),o.visible=!1,"desktop"==GDevice.type){for(h=0;h<4;h++){var i=f["p"+h];this._addDragScale(i)}this._addDragRegistration(d),this._addDragRotate(j),this._addDragRotate(k),this._addDragRotate(l),this._addDragRotate(m)}this._addDragTranslate(c),this.visible=!0},a.prototype.on=function(a,b){var c=this;"change"==a&&(c.ON_CHANGE_CALLBACK=b)},a.prototype.reset=function(){scope.DEBUGGING&&console.log("[TransformTool] Reset"),this.target=null},a.prototype._positionControls=function(){var a=this,b=a.target;a.scaleLayer.scale.x=b.scale.x,a.scaleLayer.scale.y=b.scale.y,a.translateLayer.x=b.x,a.translateLayer.y=b.y,a.ghostLayer.position.x=-b.originalSize.width*b.pivotPercent.x,a.ghostLayer.position.y=-b.originalSize.height*b.pivotPercent.y,a.registrationControl.position.x=a.ghostLayer.position.x+a.ghostLayer.width*b.pivotPercent.x,a.registrationControl.position.y=a.ghostLayer.position.y+a.ghostLayer.height*b.pivotPercent.y,a.registrationControl.scale.set(1/b.scale.x,1/b.scale.y);for(var c=0;c<4;c++){var d=a.scaleControl["p"+c];0==c&&d.position.set(-b.width*b.pivotPercent.x,-b.height*b.pivotPercent.y),1==c&&d.position.set(b.width*(1-b.pivotPercent.x),-b.height*b.pivotPercent.y),2==c&&d.position.set(b.width*(1-b.pivotPercent.x),b.height*(1-b.pivotPercent.y)),3==c&&d.position.set(-b.width*b.pivotPercent.x,b.height*(1-b.pivotPercent.y))}var e={x:b.pivotPercent.x,y:b.pivotPercent.y};a.DEBUGGING&&console.log("newAnchor:",e),e.x<.05&&e.y<.05&&e.x>-.1&&e.y>-.1?a.scaleControl.p0.visible=!1:a.scaleControl.p0.visible=!0,e.x>.95&&e.y<.05&&e.x<1.1&&e.y>-.1?a.scaleControl.p1.visible=!1:a.scaleControl.p1.visible=!0,e.x>.95&&e.y>.95&&e.x<1.1&&e.y>.9?a.scaleControl.p2.visible=!1:a.scaleControl.p2.visible=!0,e.x<.05&&e.y>.95&&e.x>-.1&&e.y>.9?a.scaleControl.p3.visible=!1:a.scaleControl.p3.visible=!0,a.rotateControl.position.x=-b.width*b.pivotPercent.x-15,a.rotateControl.position.y=b.height*-b.pivotPercent.y-15,a.rotateControl2.position.x=b.width*(1-b.pivotPercent.x)+15,a.rotateControl2.position.y=b.height*-b.pivotPercent.y-15,a.rotateControl3.position.x=b.width*(1-b.pivotPercent.x)+15,a.rotateControl3.position.y=b.height*(1-b.pivotPercent.y)+15,a.rotateControl4.position.x=-b.width*b.pivotPercent.x-15,a.rotateControl4.position.y=b.height*(1-b.pivotPercent.y)+15},a.prototype._setRegistrationPoint=function(a,b){var c=this,d=c.target,e=c.registrationControl;e.x=c.ghostLayer.x+d.originalSize.width*a,e.y=c.ghostLayer.y+d.originalSize.height*b,GPixi.setPivotPercentWithoutMoving(d,a,b),c._positionControls()},a.prototype._changeAnchor=function(a,b){var c=this,d=c.target;GPixi.setPivotPercentWithoutMoving(d,a,b),c._positionControls()},a.prototype._addDragRegistration=function(a){function i(a){return f=d.target.position,this.on("mousemove",k),this.on("touchmove",k),!0}function j(a){return this.off("mousemove",k),this.off("touchmove",k),d._setRegistrationPoint(h.x,h.y),!0}function k(a){var b=a.data.getLocalPosition(this.parent);this.position=b;var c=d.target;return h={x:(this.position.x-d.ghostLayer.position.x)/c.originalSize.width,y:(this.position.y-d.ghostLayer.position.y)/c.originalSize.height},d.DEBUGGING&&console.log("newAnchor: ",h),h.x<.05&&h.y<.05&&h.x>-.1&&h.y>-.1?d.scaleControl.p0.visible=!1:d.scaleControl.p0.visible=!0,h.x>.95&&h.y<.05&&h.x<1.1&&h.y>-.1?d.scaleControl.p1.visible=!1:d.scaleControl.p1.visible=!0,h.x>.95&&h.y>.95&&h.x<1.1&&h.y>.9?d.scaleControl.p2.visible=!1:d.scaleControl.p2.visible=!0,h.x<.05&&h.y>.95&&h.x>-.1&&h.y>.9?d.scaleControl.p3.visible=!1:d.scaleControl.p3.visible=!0,!0}this.DEBUGGING&&console.log("[TransformTool] _addDragRegistration: "+this.name);var h,d=this,f={};a.interactive=!0,a.on("mousedown",i),a.on("touchstart",i),a.on("mouseup",j),a.on("touchend",j),a.on("mouseupoutside",j),a.on("touchendoutside",j)},a.prototype._addDragRotate=function(a){function h(a){c=d=a.data.getLocalPosition(this);var h=a.data.getLocalPosition(e.rotateLayer.parent);return f=GMath.angleRadBetween2Points(h,{x:0,y:0}),g=e.target.rotation,b.DEBUGGING&&console.log(this.name),this.on("mousemove",j),this.on("touchmove",j),!0}function i(a){return this.off("mousemove",j),this.off("touchmove",j),!0}function j(a){var b=a.data.getLocalPosition(e.rotateLayer.parent),c=GMath.angleRadBetween2Points(b,{x:0,y:0}),d=c-f;return e.target.rotation=g+d,e.rotateLayer.rotation=e.target.rotation,e.ON_CHANGE_CALLBACK&&e.ON_CHANGE_CALLBACK(),!0}var g,b=this,c={},d={},e=this,f=0;b.DEBUGGING&&console.log("[TransformTool] _addDragRotate:",a.name),a.interactive=!0,a.on("mousedown",h),a.on("touchstart",h),a.on("mouseup",i),a.on("touchend",i),a.on("mouseupoutside",i),a.on("touchendoutside",i)},a.prototype._addDragTranslate=function(a){function h(a){return f={x:d.target.x,y:d.target.y},g=a.data.getLocalPosition(d.target.parent),this.on("mousemove",j),this.on("touchmove",j),!0}function i(a){return this.off("mousemove",j),this.off("touchmove",j),!0}function j(a){console.log(a.data);var b="undefined"!=typeof a.data.originalEvent.touches&&a.data.originalEvent.touches.length>1;if(!b){var c=a.data.getLocalPosition(d.target.parent),e={x:c.x-g.x,y:c.y-g.y};return d.target.position.x=f.x+e.x,d.target.position.y=f.y+e.y,d.translateLayer.x=d.target.x,d.translateLayer.y=d.target.y,d.ON_CHANGE_CALLBACK&&d.ON_CHANGE_CALLBACK(),!0}}var d=this,e=this,f={},g={};e.DEBUGGING&&console.log("[TransformTool] _addDragTranslate"),a.interactive=!0,a.buttonMode=!0,a.on("mousedown",h),a.on("touchstart",h),a.on("mouseup",i),a.on("touchend",i),a.on("mouseupoutside",i),a.on("touchendoutside",i)},a.prototype._addDragScale=function(a){function k(a){a.data.getLocalPosition(this.parent);return f=a.data.getLocalPosition(e.target.parent),g={x:e.target.scale.x,y:e.target.scale.y},h={x:e.target.pivotPercent.x,y:e.target.pivotPercent.y},b.DEBUGGING&&console.log("curAnchor: ",h),this.on("mousemove",m),this.on("touchmove",m),!0}function l(a){return this.off("mousemove",m),this.off("touchmove",m),!0}function m(a){var b=e.target,c=a.data.getLocalPosition(this.parent);this.position=c;var d=e.scaleControl.p0,f=e.scaleControl.p1,j=e.scaleControl.p2,k=e.scaleControl.p3;0==this.id&&(k.position.x=this.position.x,f.position.y=this.position.y),1==this.id&&(j.position.x=this.position.x,d.position.y=this.position.y),2==this.id&&(f.position.x=this.position.x,k.position.y=this.position.y),3==this.id&&(d.position.x=this.position.x,j.position.y=this.position.y);var l=j.position.x-d.position.x,m=j.position.y-d.position.y,n=1*l/b.originalSize.width,o=1*m/b.originalSize.height,p=n-g.x,q=g.y*p/g.x;return e.SCALE_BY_RATIO&&(o=g.y+q),0==this.id&&(i={x:1,y:1}),1==this.id&&(i={x:0,y:1}),2==this.id&&(i={x:0,y:0}),3==this.id&&(i={x:1,y:0}),e.CTRL_HOLD||e._setRegistrationPoint(i.x,i.y),b.scale.set(n,o),e._setRegistrationPoint(h.x,h.y),e.ON_CHANGE_CALLBACK&&e.ON_CHANGE_CALLBACK(),!0}var h,i,b=this,e=this,f=0,g=0;b.DEBUGGING&&console.log("[TransformTool] _addDragScale: "+this.name),a.interactive=!0,a.on("mousedown",k),a.on("touchstart",k),a.on("mouseup",l),a.on("touchend",l),a.on("mouseupoutside",l),a.on("touchendoutside",l)},a.prototype._addCornerDrag=function(a){function d(a){b=a.data.getLocalPosition(this);var c=a.data.getLocalPosition(this.parent);return c.x-=b.x,c.y-=b.y,this.position=c,this.on("mousemove",f),this.on("touchmove",f),!0}function e(a){return c.DEBUGGING&&console.log("end drag"),this.off("mousemove",f),this.off("touchmove",f),!0}function f(a){var d=a.data.getLocalPosition(this.parent);d.x-=b.x,d.y-=b.y,1!=this.id&&5!=this.id&&(this.position.x=d.x),3!=this.id&&7!=this.id&&(this.position.y=d.y),0==this.id&&(c.corners[1].position.y=c.corners[2].position.y=this.position.y,c.corners[7].position.x=c.corners[6].position.x=this.position.x),1==this.id&&(c.corners[0].position.y=c.corners[2].position.y=this.position.y),2==this.id&&(c.corners[3].position.x=c.corners[4].position.x=this.position.x,c.corners[0].position.y=c.corners[1].position.y=this.position.y),3==this.id&&(c.corners[2].position.x=c.corners[4].position.x=this.position.x),4==this.id&&(c.corners[2].position.x=c.corners[3].position.x=this.position.x,c.corners[5].position.y=c.corners[6].position.y=this.position.y),5==this.id&&(c.corners[4].position.y=c.corners[6].position.y=this.position.y),6==this.id&&(c.corners[0].position.x=c.corners[7].position.x=this.position.x,c.corners[4].position.y=c.corners[5].position.y=this.position.y),7==this.id&&(c.corners[0].position.x=c.corners[6].position.x=this.position.x);var e=c.corners[4].position.x-c.corners[0].position.x,f=c.corners[4].position.y-c.corners[0].position.y;c.corners[1].position.x=c.corners[5].position.x=c.corners[0].position.x+e/2,c.corners[3].position.y=c.corners[7].position.y=c.corners[0].position.y+f/2,c.moveLayer.position.x=c.corners[0].position.x,c.moveLayer.position.y=c.corners[0].position.y,c.moveLayer.layer.width=e,c.moveLayer.layer.height=f,c.target.position=c.corners[0].position;var g=e/c.target.originalSize.width,h=f/c.target.originalSize.height;return c.target.scale.set(g,h),c.positionCorner(),!0}var b={},c=this;a.on("mousedown",d),a.on("touchstart",d),a.on("mouseup",e),a.on("touchend",e),a.on("mouseupoutside",e),a.on("touchendoutside",e)},a.prototype._addDrag=function(a){function d(a){b=a.data.getLocalPosition(this);var c=a.data.getLocalPosition(this.parent);return c.x-=b.x,c.y-=b.y,this.position=c,this.on("mousemove",f),this.on("touchmove",f),!0}function e(a){return this.off("mousemove",f),this.off("touchmove",f),!0}function f(a){b||(b=a.data.getLocalPosition(this));var d=a.data.getLocalPosition(this.parent);return d.x-=b.x,d.y-=b.y,this.position=d,c.target.position=this.position,c.rotateLayer.position=this.position,c.positionCorner(),!0}var b=null,c=this;a.on("mousedown",d),a.on("touchstart",d),a.on("mouseup",e),a.on("touchend",e),a.on("mouseupoutside",e),a.on("touchendoutside",e),a.on("mousemove",f),a.on("touchmove",f)},a.prototype.positionCorner=function(){var a=this.moveLayer,b=this;if(a){var c=a.layer.width,d=a.layer.height;this.corners[0].position.set(a.position.x,a.position.y),this.corners[1].position.set(a.position.x+c/2,a.position.y),this.corners[2].position.set(a.position.x+c,a.position.y),this.corners[3].position.set(a.position.x+c,a.position.y+d/2),this.corners[4].position.set(a.position.x+c,a.position.y+d),this.corners[5].position.set(a.position.x+c/2,a.position.y+d),this.corners[6].position.set(a.position.x,a.position.y+d),this.corners[7].position.set(a.position.x,a.position.y+d/2),b.rotateLayer.pivotCorner.x=c/2,b.rotateLayer.pivotCorner.y=d/2}},PIXI.TransformTool=a}).call(this);